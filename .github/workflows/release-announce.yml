name: Release Announce

# Handles Discord notifications for manually-created releases.
# Automated releases on merge are handled by auto-release.yml (which posts
# to Discord directly, since GITHUB_TOKEN releases don't trigger this workflow).

on:
  release:
    types: [published]

jobs:
  discord:
    runs-on: ubuntu-latest

    steps:
      - name: Post to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          RELEASE_BODY: ${{ github.event.release.body }}
          RELEASE_URL: ${{ github.event.release.html_url }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "DISCORD_WEBHOOK_URL secret not set, skipping Discord notification"
            exit 0
          fi

          # Truncate body to 1900 chars for Discord's 2000 char limit
          if [ ${#RELEASE_BODY} -gt 1900 ]; then
            RELEASE_BODY="${RELEASE_BODY:0:1897}..."
          fi

          MESSAGE=$(printf '**Soleur %s released!**\n\n%s\n\nFull release notes: %s' \
            "$RELEASE_TAG" "$RELEASE_BODY" "$RELEASE_URL")

          # Build JSON payload safely with jq
          PAYLOAD=$(jq -n --arg content "$MESSAGE" '{content: $content}')

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            "$DISCORD_WEBHOOK_URL")

          if [[ "$HTTP_CODE" =~ ^2 ]]; then
            echo "Discord notification sent (HTTP $HTTP_CODE)"
          else
            echo "::warning::Discord notification failed (HTTP $HTTP_CODE)"
          fi
