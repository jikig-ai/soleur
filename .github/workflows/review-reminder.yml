name: Review Reminders

on:
  schedule:
    - cron: '0 0 1 * *'
  workflow_dispatch:
    inputs:
      date_override:
        description: 'Override today date (YYYY-MM-DD) for testing'
        required: false
        type: string

permissions:
  issues: write
  contents: read

jobs:
  check-reviews:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Scan for due reviews
        env:
          GH_TOKEN: ${{ github.token }}
          DATE_OVERRIDE: ${{ inputs.date_override }}
          SERVER_URL: ${{ github.server_url }}
          REPO_NAME: ${{ github.repository }}
        run: |
          # Validate date_override format if provided
          if [[ -n "$DATE_OVERRIDE" ]]; then
            if ! [[ "$DATE_OVERRIDE" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
              echo "::error::date_override must be YYYY-MM-DD, got: $DATE_OVERRIDE"
              exit 1
            fi
            today="$DATE_OVERRIDE"
          else
            today=$(date -u +%Y-%m-%d)
          fi
          echo "Using date: $today"

          today_epoch=$(date -d "$today" +%s)
          created=0
          skipped=0

          # Ensure label exists (once, before loop)
          gh label create review-reminder --description "Auto-created review reminder" --color "0E8A16" 2>/dev/null || true

          while IFS= read -r file; do
            # Extract review_cadence from YAML frontmatter (opt-in field)
            review_cadence=$(sed -n '/^---$/,/^---$/{ /^review_cadence:/{ s/.*: *//; p; q; } }' "$file")

            if [[ -z "$review_cadence" ]]; then
              continue
            fi

            # Map cadence to days
            case "$review_cadence" in
              monthly)   cadence_days=30 ;;
              quarterly) cadence_days=90 ;;
              biannual)  cadence_days=180 ;;
              annual)    cadence_days=365 ;;
              *) echo "::warning::Skipping $file -- unknown review_cadence: $review_cadence"; continue ;;
            esac

            # Extract last_reviewed; if missing, treat as immediately stale
            last_reviewed=$(sed -n '/^---$/,/^---$/{ /^last_reviewed:/{ s/.*: *//; p; q; } }' "$file")

            if [[ -z "$last_reviewed" ]]; then
              days_until=-1
            else
              if ! last_epoch=$(date -d "$last_reviewed" +%s 2>/dev/null); then
                echo "::warning::Skipping $file -- invalid last_reviewed date: $last_reviewed"
                continue
              fi
              next_due_epoch=$((last_epoch + cadence_days * 86400))
              days_until=$(( (next_due_epoch - today_epoch) / 86400 ))
            fi

            # Flag documents due within 7 days or already past due
            if [[ $days_until -gt 7 ]]; then
              continue
            fi

            # Build deterministic title from relative path
            slug="${file#knowledge-base/}"
            slug="${slug%.md}"
            expected_title="Review Reminder: $slug"

            # Check for existing open issue with exact title match
            match=$(gh issue list --label review-reminder --state open --json title --jq '.[].title' | grep -cxF "$expected_title" || true)
            if [[ "$match" -gt 0 ]]; then
              echo "Skipping $file -- open issue already exists"
              skipped=$((skipped + 1))
              continue
            fi

            # Extract title from frontmatter (fallback to slug)
            doc_title=$(sed -n '/^---$/,/^---$/{ /^title:/{ s/.*: *//; p; q; } }' "$file")
            if [[ -z "$doc_title" ]]; then
              doc_title="$slug"
            fi

            # Compute review due date for display
            if [[ -n "$last_reviewed" ]]; then
              review_due=$(date -d "$last_reviewed + $cadence_days days" +%Y-%m-%d)
            else
              review_due="immediately (no last_reviewed set)"
            fi

            # Create issue
            repo_url="${SERVER_URL}/${REPO_NAME}"
            file_link="${repo_url}/blob/main/${file}"

            issue_body="## Review Due: ${doc_title}

          **Review due:** ${review_due}
          **Last reviewed:** ${last_reviewed:-never}
          **Cadence:** ${review_cadence}
          **Source:** [${file}](${file_link})

          When complete:
          - [ ] Update \`last_reviewed\` to today's date in the source document's YAML frontmatter
          - [ ] Close this issue

          _Auto-created by the [review-reminder workflow](${repo_url}/actions/workflows/review-reminder.yml)._"

            if gh issue create \
              --title "$expected_title" \
              --body "$issue_body" \
              --label "review-reminder"; then
              echo "Created issue: $expected_title"
              created=$((created + 1))
            else
              echo "::error::Failed to create issue for $file"
              exit 1
            fi

          done < <(find knowledge-base -name '*.md' -type f 2>/dev/null)

          echo ""
          echo "Summary: created=$created, skipped=$skipped"
