# Monthly competitive intelligence scan using the soleur:competitive-analysis skill.
# Produces a GitHub Issue with competitive landscape findings for tiers 0 and 3.
# Persists the report to knowledge-base/overview/competitive-intelligence.md on main.
# First consumer of the soleur:schedule infrastructure (v3.5.0).
# To test manually: gh workflow run scheduled-competitive-analysis.yml

name: Competitive Analysis

on:
  schedule:
    - cron: '0 9 1 * *'
  workflow_dispatch:

concurrency:
  group: schedule-competitive-analysis
  cancel-in-progress: false

permissions:
  issues: write
  contents: write
  id-token: write

jobs:
  competitive-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Ensure label exists
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh label create scheduled-competitive-analysis \
            --description "Monthly competitive analysis report" \
            --color "0E8A16" 2>/dev/null || true

      - name: Run scheduled skill
        uses: anthropics/claude-code-action@1dd74842e568f373608605d9e45c9e854f65f543 # v1.0.63
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          plugin_marketplaces: 'https://github.com/jikig-ai/soleur.git'
          plugins: 'soleur@soleur'
          claude_args: '--model claude-opus-4-6 --max-turns 45 --allowedTools Bash,Read,Write,Edit,Glob,Grep,WebSearch,WebFetch,Task'
          prompt: |
            Run /soleur:competitive-analysis --tiers 0,3 on this repository.
            After your analysis is complete, create a GitHub issue titled
            "[Scheduled] Competitive Analysis - <today's date in YYYY-MM-DD format>"
            with the label "scheduled-competitive-analysis" summarizing your findings.

      - name: Persist competitive intelligence report
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          FILE="knowledge-base/overview/competitive-intelligence.md"
          if [ ! -f "$FILE" ]; then
            echo "::warning::Report file not found, skipping persist step"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Re-authenticate after claude-code-action revokes the installation token
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git"

          git add "$FILE"

          # Skip if report content is identical to what's on main
          if git diff --cached --quiet; then
            echo "::notice::Report unchanged, skipping"
            exit 0
          fi

          git commit -m "docs: update competitive intelligence report"

          # Retry with rebase if main has diverged during the run
          git push origin main || {
            git pull --rebase origin main
            git push origin main
          }
