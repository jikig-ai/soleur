# Context Compaction Optimization

**Issue:** #268
**Brainstorm:** [2026-02-22-context-compaction-brainstorm.md](../../brainstorms/2026-02-22-context-compaction-brainstorm.md)
**Branch:** feat-context-compaction

## Problem Statement

The Soleur plugin's 60 agents, 46 skills, and 9 commands create ~10k tokens of always-on context baseline per turn. Multi-step workflows (brainstorm -> plan -> work -> review -> compound) accumulate 50k+ tokens of command/skill instructions by mid-pipeline with no compaction mechanism, causing frequent context window compaction that degrades response quality.

## Goals

1. Reduce baseline context consumption per command invocation by moving heavy content to references/ files
2. Deduplicate repeated constitution loading across pipeline steps
3. Add a safe compaction boundary at the brainstorm-to-plan transition via subagent isolation
4. Preserve compound's error visibility across compaction boundaries via session-state file

## Non-Goals

- Compacting between plan/work/compound steps (breaks compound HARD RULEs)
- Dynamic agent description trimming (already optimized, diminishing returns)
- Programmatic /compact invocation (not available as a tool)
- Full session-state schema or checkpoint/restore system

## Functional Requirements

- **FR1**: Command templates (plan's issue templates, brainstorm's domain config table) must be moved to references/ subdirectories and loaded on demand
- **FR2**: Constitution loading must be deduplicated -- commands should not re-read constitution.md if a prior command already loaded it in the same session
- **FR3**: Command bodies must be trimmed by extracting procedural details into references/ files, targeting ~50% size reduction
- **FR4**: One-shot pipeline must spawn plan as an isolated Task subagent after brainstorm completes
- **FR5**: Plan subagent must return a structured summary (errors, decisions, components invoked) to the parent
- **FR6**: Parent must write the summary to `knowledge-base/specs/feat-<name>/session-state.md` in append-only mode
- **FR7**: Compound must read session-state.md in addition to scanning conversation history for error inventory

## Technical Requirements

- **TR1**: references/ files must follow existing skill reference conventions (Read tool loading, not always-on)
- **TR2**: Session-state file must be append-only with clear step headers for each pipeline phase
- **TR3**: Changes must not break existing standalone command invocations (brainstorm alone, plan alone, etc.)
- **TR4**: Constitution deduplication must work across both one-shot pipelines and manual sequential invocations

## Acceptance Criteria

- [ ] Average command body size reduced from ~3,000 words to ~1,500 words
- [ ] Constitution loaded at most once per pipeline run
- [ ] Plan runs as isolated subagent in one-shot pipeline
- [ ] Session-state file created and appended to during pipeline execution
- [ ] Compound reads session-state.md and includes forwarded errors in learning output
- [ ] All existing standalone command invocations still work correctly
