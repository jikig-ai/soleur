# Tasks: Context Compaction Optimization

## Phase 1: Verify and Setup

- [ ] 1.1: Create test file `commands/soleur/references/loader-test.md` with valid command frontmatter
- [ ] 1.2: Verify it does NOT appear as a discoverable command
- [ ] 1.3: If it DOES appear, use fallback path `plugins/soleur/references/commands/`
- [ ] 1.4: Remove test file and create final reference directory

## Phase 2: Extract Command Content to References

### brainstorm.md (2,906w -> ~1,300w)
- [ ] 2.1: Extract domain config table to `references/brainstorm-domain-config.md`
- [ ] 2.2: Extract Brand Workshop to `references/brainstorm-brand-workshop.md`
- [ ] 2.3: Extract Validation Workshop to `references/brainstorm-validation-workshop.md`
- [ ] 2.4: Replace extracted content with Read instructions in brainstorm.md
- [ ] 2.5: Add Prong 2b message to brainstorm's Phase 4 output ("All artifacts are on disk. Starting a new session for `/soleur:plan` will give you maximum context headroom.")
- [ ] 2.6: Verify standalone brainstorm works

### plan.md (3,274w -> ~1,800w)
- [ ] 2.7: Extract 3 issue templates to `references/plan-issue-templates.md`
- [ ] 2.8: Extract Community Discovery to `references/plan-community-discovery.md`
- [ ] 2.9: Extract Functional Overlap to `references/plan-functional-overlap.md`
- [ ] 2.10: Replace extracted content with Read instructions in plan.md
- [ ] 2.11: Verify standalone plan works with each detail level

### work.md (2,946w -> ~2,000w)
- [ ] 2.12: Extract Agent Teams protocol to `references/work-agent-teams.md`
- [ ] 2.13: Extract Subagent Fan-Out protocol to `references/work-subagent-fanout.md`
- [ ] 2.14: Replace extracted content with Read instructions in work.md
- [ ] 2.15: Verify standalone work works with all tiers

### review.md (2,500w -> ~1,700w)
- [ ] 2.16: Extract todo file structure to `references/review-todo-structure.md`
- [ ] 2.17: Extract E2E testing section to `references/review-e2e-testing.md`
- [ ] 2.18: Replace extracted content with Read instructions in review.md
- [ ] 2.19: Verify standalone review works

## Phase 3: Constitution Deduplication

Only plan.md and work.md explicitly load constitution.md. Other commands only load CLAUDE.md.

- [ ] 3.1: Update plan.md Phase 0 with conditional: "If `# Project Constitution` content is already present in this conversation, skip reading constitution.md"
- [ ] 3.2: Update work.md Phase 0 with the same conditional
- [ ] 3.3: Verify standalone plan and work still load constitution on first run
- [ ] 3.4: Verify that in a pipeline (plan then work), work skips the re-read

## Phase 4: One-Shot Subagent Isolation

- [ ] 4.1: Define session-state.md format with concrete example
- [ ] 4.2: Modify one-shot.md to spawn steps 1-2 as combined Task subagent
- [ ] 4.3: Add subagent return contract to Task prompt
- [ ] 4.4: Add parent logic to parse output and write session-state.md
- [ ] 4.5: Add fallback for subagent failure or malformed output
- [ ] 4.6: Verify one-shot pipeline works with subagent

## Phase 5: Compound Session-State Integration

- [ ] 5.1: Update compound.md Phase 0.5 to read session-state.md if it exists
- [ ] 5.2: Update compound.md Route-to-Definition for session-state components
- [ ] 5.3: Update compound-docs SKILL.md Step 2 to read session-state.md
- [ ] 5.4: Verify compound with session-state.md present
- [ ] 5.5: Verify compound without session-state.md (standalone fallback)

## Phase 6: Measurement and Validation

- [ ] 6.1: Measure final word counts for all modified commands
- [ ] 6.2: Calculate total reduction percentage (target: ~40% reduction from 13,292w)
- [ ] 6.3: Verify all acceptance criteria
