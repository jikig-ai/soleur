---
title: feat: Autonomous single-PR merge pipeline
type: feat
date: 2026-02-22
version-bump: MINOR
---

# feat: Autonomous single-PR merge pipeline

## Overview

Build a new skill `/soleur:merge-pr` that automates the merge pipeline for a single PR -- replacing the manual execution of `/ship` Phases 3.5-8. The skill takes a branch name (or auto-detects from current branch) and runs lights-out: merge main, resolve conflicts, version bump, push, create PR, wait for CI, merge, and cleanup. Report results at the end.

## Problem Statement

From Claude Code Insights (139 sessions):
- Git operations (53 sessions) and PR merges (42 sessions) are the top two activities
- Merge conflicts recur (11 instances), especially in version files
- /ship Phases 3.5-8 are mechanical, repetitive, and error-prone

## Proposed Solution

A single SKILL.md at `plugins/soleur/skills/merge-pr/SKILL.md` with phased instructions that Claude follows sequentially. No scripts, no agents, no sub-skills. On any failure, stop and report.

### Relationship to /ship

Both skills are independent user-invoked entry points. They must never invoke each other (constitution: "Never design skills that invoke other skills programmatically"). The intended user workflow:

```text
1. /ship (Phases 0-3: validate, compound, docs)   -- user invokes
2. /soleur:merge-pr                                 -- user invokes separately
```

Or standalone: `/soleur:merge-pr` validates its own pre-conditions (compound, clean worktree) and handles everything from merge-main through cleanup.

## Technical Considerations

### Conflict Resolution

**Version files (deterministic):** Since the version bump step overwrites these anyway, accept main's version for all of them. CHANGELOG is the exception -- preserve both entries.

| File | Resolution |
|------|-----------|
| `plugins/soleur/.claude-plugin/plugin.json` | Accept main's version (re-bumped next step) |
| `plugins/soleur/CHANGELOG.md` | Read both sides via `git show :2:` (ours) and `git show :3:` (theirs); merge entries in descending version order |
| `plugins/soleur/README.md` | Accept feature branch component counts |
| `README.md` (root) | Accept main's badge (re-bumped next step) |
| `.github/ISSUE_TEMPLATE/bug_report.yml` | Accept main's placeholder (re-bumped next step) |

**Code conflicts:** Read the conflict markers and resolve based on intent. If resolution confidence is low, run `git merge --abort` and stop.

**CHANGELOG integrity:** During a merge conflict, read both sides using git stage numbers (`git show :2:path` for ours, `git show :3:path` for theirs), not `git show HEAD:`. Reconstruct the complete file -- never truncate. Verify line count after writing.

### Version Bump

Only if `git diff --name-only origin/main...HEAD -- plugins/soleur/` has results. If no plugin files changed, skip the entire bump.

Bump type per AGENTS.md rules: new files in `skills/`, `agents/`, or `commands/` = MINOR; otherwise PATCH. The agent writes the CHANGELOG entry the same way it does in /ship -- no auto-generation from PR metadata.

Update the versioning triad (`plugin.json`, `CHANGELOG.md`, `plugins/soleur/README.md`) plus 2 sync targets (root `README.md` badge, `bug_report.yml` placeholder).

### Guardrails Compatibility

All commits happen on the feature branch. Guard 1 (commit-on-main block) is never triggered. Guard 3 (`--delete-branch` block) is avoided by using `--squash` only.

### Rollback

If the pipeline fails partway through (merge + version bump committed but CI fails), rollback to pre-pipeline state:

```bash
git log --oneline -5  # find the commit before merge-pr started
git reset --hard <pre-merge-pr-commit>
git push --force-with-lease origin <branch>
```

The skill notes the starting commit SHA at the beginning of the run to enable this.

## Acceptance Criteria

- [ ] Skill invocable as `/soleur:merge-pr` with optional branch argument
- [ ] Auto-detects current feature branch when no argument provided
- [ ] Validates pre-conditions: not on main, no uncommitted changes, compound has run
- [ ] Merges `origin/main` into feature branch
- [ ] Auto-resolves version file conflicts using deterministic heuristics
- [ ] Attempts Claude-assisted resolution for code conflicts
- [ ] Aborts cleanly on unresolvable conflicts (`git merge --abort`)
- [ ] Skips version bump when no plugin files changed
- [ ] Bumps version correctly (MINOR/PATCH per AGENTS.md rules) when plugin files changed
- [ ] Updates versioning triad + 2 sync targets
- [ ] Pushes and creates PR (or updates existing)
- [ ] Waits for CI (`gh pr checks --watch --fail-fast`)
- [ ] Merges with `gh pr merge --squash` (never `--delete-branch`)
- [ ] Navigates to repo root and runs `cleanup-merged`
- [ ] Prints end-of-run report
- [ ] On any failure: stops cleanly and reports what failed

## Test Scenarios

- Given a feature branch with compound run and clean worktree, when merge-pr is invoked, then main is merged, version bumped, PR created, CI passes, PR merged, worktree cleaned
- Given main has advanced 2 versions since branch creation, when merge-pr merges main, then version files are resolved to main's version and re-bumped
- Given main has new CHANGELOG entries, when merge-pr resolves conflicts, then both entries are preserved in descending version order and the file is not truncated
- Given a code conflict, when Claude cannot confidently resolve it, then `git merge --abort` runs and the pipeline stops with a report of conflicted files
- Given unarchived KB artifacts exist, when merge-pr is invoked, then it stops with an error directing the user to run `/soleur:compound` first
- Given CI fails after push, when merge-pr detects the failure, then it stops and reports the failed check names
- Given no files under `plugins/soleur/` changed, when merge-pr reaches the version bump step, then it skips the bump entirely

## Dependencies & Risks

| Risk | Mitigation |
|------|-----------|
| Silent bad merge from Claude-assisted resolution | CI tests catch most issues; lights-out means accepting this risk |
| CHANGELOG truncation during conflict resolution | Read both sides via `:2:` and `:3:` stage numbers; verify line count |
| Main advances between CI pass and merge attempt | `gh pr merge` returns clear error; user re-runs the skill |
| Token budget for complex conflicts | Single-PR mode limits scope; abort if uncertain |

## Non-Goals (Deferred)

- Multi-PR queue orchestration (Phase 2, YAGNI)
- Batched releases / committing version bump directly to main
- Stripping existing version bumps from already-bumped PRs
- Queue state persistence for resumability
- Modifying /ship to hand off to this skill (constitution prohibits inter-skill invocation)

## Implementation

One deliverable: `plugins/soleur/skills/merge-pr/SKILL.md`

The SKILL.md contains phased instructions (Phase 0 through Phase 7) that Claude follows sequentially. The phases map to the pipeline steps:

| Phase | Purpose | Key Commands |
|-------|---------|-------------|
| 0 | Context detection | `git branch --show-current`, note starting commit SHA |
| 1 | Pre-condition validation | `git status --porcelain`, check for unarchived KB artifacts |
| 2 | Merge main | `git fetch origin main && git merge origin/main` |
| 3 | Conflict resolution | Deterministic for version files, Claude-assisted for code, `git merge --abort` on failure |
| 4 | Version bump (conditional) | Check `git diff --name-only origin/main...HEAD -- plugins/soleur/`; if empty, skip |
| 5 | Push and PR | `git push -u origin <branch>`, `gh pr create` or verify existing |
| 6 | CI and merge | `gh pr checks --watch --fail-fast`, `gh pr merge <number> --squash` |
| 7 | Cleanup and report | Navigate to repo root, `cleanup-merged`, print summary |

After writing the SKILL.md, register in plugin README (Workflow category), update component counts, and bump version (MINOR -- new skill).

## Sequence Diagram

```text
User invokes /soleur:merge-pr [branch]
    |
    v
Phase 0: Detect context (branch, worktree, starting SHA)
    |
    v
Phase 1: Validate pre-conditions -----> FAIL: stop, report what failed
    |                                     (direct to /soleur:compound if needed)
    | PASS
    v
Phase 2: git fetch + git merge origin/main
    |
    +---> No conflicts: continue
    |
    +---> Conflicts detected
              |
              v
         Phase 3: Resolve conflicts
              |
              +---> Version files: deterministic (accept main)
              +---> CHANGELOG: merge both sides via :2:/:3:
              +---> Code: Claude-assisted
              |
              +---> Unresolvable: git merge --abort, STOP
              |
              | Resolved
              v
         git add + git commit
    |
    v
Phase 4: Version bump? -----> No plugin files changed: SKIP
    |
    | Plugin files changed
    v
    Bump version (triad + 2 sync targets)
    git commit
    |
    v
Phase 5: git push, create/update PR
    |
    v
Phase 6: gh pr checks --watch --fail-fast
    |
    +---> CI fails: STOP, report failed checks
    |
    | CI passes
    v
    gh pr merge --squash
    |
    v
Phase 7: cd to repo root, cleanup-merged
    |
    v
    Print end-of-run report (PR URL, version, merge SHA)
    DONE
```

## References

- Brainstorm: `knowledge-base/brainstorms/2026-02-22-merge-queue-brainstorm.md`
- Spec: `knowledge-base/specs/feat-merge-queue/spec.md`
- Issue: #214
- /ship skill: `plugins/soleur/skills/ship/SKILL.md` (Phases 3.5-8 being replicated)
- Guardrails: `.claude/hooks/guardrails.sh`
- Worktree cleanup: `plugins/soleur/skills/git-worktree/scripts/worktree-manager.sh`
- CHANGELOG truncation learning: `knowledge-base/learnings/integration-issues/2026-02-17-truncated-changelog-during-rebase-conflict-resolution.md`
